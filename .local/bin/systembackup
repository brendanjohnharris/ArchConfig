#! /bin/bash

# * Backup dotfiles
git --git-dir="$HOME/ArchConfig/" --work-tree="$HOME" add -u $HOME/
git --git-dir="$HOME/ArchConfig/" --work-tree="$HOME" commit -m "System backup"
git --git-dir="$HOME/ArchConfig/" --work-tree="$HOME" push origin main

# * Create local backup of system files
# Initialize borg repository if it doesn't exist
# export BORG_PASSPHRASE=$(sudo cat /etc/backups/password)
export BORG_PASSPHRASE_FD="/etc/backups/password"
# export BORG_NEW_PASSPHRASE=$(sudo cat /etc/backups/password)
export BORG_PASSCOMMAND="cat /etc/backups/password"
if [ ! -d "/home/brendan/OneDrive/systembackup/" ]; then
    sudo -E borg init --encryption=repokey /home/brendan/OneDrive/systembackup/
fi

# Create a new backup
sudo -E borg create --progress --filter AME --stats --show-rc --compression zstd,9 --exclude-caches \
    --exclude '/bin/*' \
    --exclude '/var/*' \
    --exclude '/boot/*' \
    --exclude '/dev/*' \
    --exclude '/home/*' \
    --exclude '/lib/*' \
    --exclude '/lib32/*' \
    --exclude '/lib64/*' \
    --exclude '/media/*' \
    --exclude '/mnt/*' \
    --exclude '/proc/*' \
    --exclude '/run/*' \
    --exclude '/sbin/*' \
    --exclude '/srv/*' \
    --exclude '/sys/*' \
    --exclude '/tmp/*' \
    --exclude '/usr/bin/*' \
    --exclude '/usr/local/*' \
    --exclude '/usr/include/*' \
    --exclude '/usr/lib/*' \
    --exclude '/usr/lib32/*' \
    --exclude '/usr/libexec/*' \
    --exclude '/usr/sbin/*' \
    --exclude '/usr/share/*' \
    --exclude '/usr/src/*' \
    --exclude '/opt/anaconda/*' \
    --exclude '/Chambertin/*' \
    --exclude '/etc/backup/*' \
    --exclude '/home/brendan/OneDrive/systembackup/*' \
    /home/brendan/OneDrive/systembackup/::'{hostname}-{now:%Y-%m-%d-%H%M%S}' /

# Prune old backups
sudo -E borg prune -v --list /home/brendan/OneDrive/systembackup/ --keep-daily=7 --keep-weekly=4 --keep-monthly=6

# * Sync with onedrive
if [ -d "$HOME/OneDrive/" ]; then
    sudo rclone \
        --config="/home/brendan/.config/rclone/rclone.conf" \
        sync \
        -L \
        --progress \
        --stats-file-name-length=0 \
        --checkers=16 \
        --transfers=16 \
        --buffer-size 512M \
        --checksum \
        "$HOME/OneDrive/" onedrive:desktop_clone/OneDrive/ \
        --exclude="/**/.CondaPkg/" \
        --exclude="/**/aux/" \
        --exclude="/**/.git/" \
        --exclude="/**/.conda/" \
        --exclude="/**/.npm/" \
        --exclude="/**/node_modules/"
fi
